import os
import json
from openai import OpenAI
from dotenv import load_dotenv

load_dotenv()

client = OpenAI(
    api_key=os.getenv("DEEPSEEK_API_KEY"), 
    base_url="https://api.deepseek.com"
)

def ai_todo_list(text):
    print(f"æ­£åœ¨åˆ†ææ—¥ç¨‹ï¼š{text} ...")
    
    # ---------------------------------------------------
    # ğŸ’€ ä½ çš„ä»»åŠ¡ï¼šåœ¨è¿™é‡Œå†™å‡ºå®Œç¾çš„ Prompt
    # è®°å¾—ç”¨ RTFC å…¬å¼ï¼šè§’è‰²ã€ä»»åŠ¡ã€æ ¼å¼ã€çº¦æŸ
    # ---------------------------------------------------

    # 60åˆ†çš„ç®€å•prompt
    # system_prompt = """
    # ä½ æ˜¯ä¸€ä¸ªå¾…åŠäº‹é¡¹çš„å°åŠ©æ‰‹ï¼Œä½ éœ€è¦æ ¹æ®ç”¨æˆ·è¾“å…¥çš„å†…å®¹ï¼Œæå–å‡ºæ¯ä¸ªäº‹é¡¹çš„å†…å®¹æ—¶é—´å’Œä¼˜å…ˆçº§ï¼Œä¼˜å…ˆçº§ä½ è‡ªå·±åˆ¤æ–­ï¼Œè¯·ç»™æˆ‘ä¸¥æ ¼çš„JSONåˆ—è¡¨ï¼Œ
    # ä¸è¦è¿”å›æˆ‘ç»™æˆ‘å¤šä½™çš„ä¿¡æ¯ï¼Œæ¯”å¦‚â€œè¿™æ˜¯ä½ éœ€è¦åšçš„äº‹æƒ…ï¼šâ€ä¹‹ç±»çš„
    # """

    # æ»¡åˆ†çš„é«˜çº§prompt
    system_prompt = """
    # Role
    ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ—¥ç¨‹ç®¡ç†åŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯ä»ç”¨æˆ·çš„è‡ªç„¶è¯­è¨€ä¸­æå–å¾…åŠäº‹é¡¹ã€‚

    # Output Format
    è¯·ä»…è¾“å‡ºä¸€ä¸ªçº¯ JSON æ•°ç»„ï¼ˆArrayï¼‰ï¼Œä¸è¦åŒ…å« ```json ä»£ç å—æ ‡è®°ã€‚
    æ•°ç»„ä¸­çš„æ¯ä¸ªå¯¹è±¡å¿…é¡»åŒ…å«ä»¥ä¸‹ä¸‰ä¸ªå­—æ®µï¼š
    1. "event": (String) äº‹é¡¹çš„å…·ä½“å†…å®¹ã€‚
    2. "time": (String) æ—¶é—´æè¿°ã€‚å¦‚æœæ²¡æåˆ°æ—¶é—´ï¼Œå¡« "å¾…å®š"ã€‚
    3. "priority": (String) åªèƒ½å¡« "é«˜"ã€"ä¸­"ã€"ä½" ä¸‰è€…ä¹‹ä¸€ã€‚

    # Priority Rules (ä¼˜å…ˆçº§åˆ¤æ–­æ ‡å‡†)
    - "é«˜": æ¶‰åŠå·¥ä½œæˆªæ­¢æ—¥æœŸã€ç´§æ€¥ä¼šè®®ã€åŒ»ç–—å¥åº·ã€‚
    - "ä¸­": ç”Ÿæ´»çäº‹ã€è´­ç‰©ã€æ™®é€šçº¦ä¼šã€‚
    - "ä½": å¨±ä¹ã€æ²¡æœ‰æ˜ç¡®æœŸé™çš„æƒ³æ³•ã€‚

    # Few-Shot Examples (ç…§ç€è¿™ä¸ªå­¦)
    ç”¨æˆ·è¾“å…¥: "æ˜å¤©æ—©ä¸Š9ç‚¹è¦æŠŠPPTå‘ç»™è€æ¿ï¼Œé¡ºä¾¿å¸®æˆ‘ä¹°æ¯å’–å•¡ã€‚"
    ä½ çš„è¾“å‡º:
    [
        {"event": "å‘é€PPTç»™è€æ¿", "time": "æ˜å¤© 09:00", "priority": "é«˜"},
        {"event": "ä¹°å’–å•¡", "time": "æ˜å¤©", "priority": "ä¸­"}
    ]

    # Constraints
    1. å¦‚æœç”¨æˆ·è¾“å…¥çš„å†…å®¹æ²¡æœ‰åŒ…å«ä»»ä½•å¾…åŠäº‹é¡¹ï¼Œè¿”å›ç©ºæ•°ç»„ []ã€‚
    2. ä¸¥æ ¼éµå®ˆä¸Šè¿° Key çš„å‘½åï¼ˆevent, time, priorityï¼‰ï¼Œç¦æ­¢ä¿®æ”¹é”®åã€‚
    """

    try:
        response = client.chat.completions.create(
            model="deepseek-chat",
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": text}
            ],
            stream=False
        )
        
        result = response.choices[0].message.content
        data = json.loads(result)
        return data

    except json.JSONDecodeError:
        print("è§£æå¤±è´¥ï¼AI å¯èƒ½æ²¡è¿”å›çº¯åˆ—è¡¨ã€‚")
        print("AI è¿”å›äº†ï¼š", result)
        return None
    except Exception as e:
        print(f"å‡ºé”™ï¼š{e}")
        return None

if __name__ == "__main__":
    # æ¨¡æ‹Ÿç”¨æˆ·çš„è¯­éŸ³è¾“å…¥
    user_input = "åå¤©ä¸Šåˆæé†’æˆ‘ç»™å¦ˆå¦ˆæ‰“ç”µè¯ï¼Œè¿˜æœ‰è¿™å‘¨äº”ä¹‹å‰è¦æŠŠPPTåšå®Œï¼Œå¯¹äº†ï¼Œä»Šæ™šè¦å»ä¹°çŒ«ç²®ã€‚"
    
    todos = ai_todo_list(user_input)
    
    if todos:
        print("\nâœ… æå–æˆåŠŸï¼å¾…åŠäº‹é¡¹å¦‚ä¸‹ï¼š")
        print("---------------------------------")
        # è¿™é‡Œç”¨äº†ä¸€ä¸ªå¾ªç¯ï¼Œè¿™æ˜¯ Python å¤„ç†åˆ—è¡¨çš„æ–¹å¼
        for item in todos:
            print(f"[{item['priority']}] {item['time']} -> {item['event']}")
        print("---------------------------------")